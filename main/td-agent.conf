#
# for td-agent.conf for container
#
# forward container syslog-ng data in rfc5424 format - plugin has also been removed
#<source>
 # @type http_heartbeat
 # port 24223
 # bind 0.0.0.0
#</source>

# feed from remote supervisord.log
<source>
  @type tail
  read_lines_limit 10
  path /var/log/supervisord.log
  pos_file "/var/log/td-agent/supervisord.pos"
  tag supervisord
  <parse>
    @type regexp
    expression /^(?<time>[0-9]{4}\-[0-9]{2}\-[0-9]{2}[ ][0-9]{2}\:[0-9]{2}\:[0-9]{2}\,[0-9]{3}) (?<msg_type>[^ ]*) (?<message>.+)$/
    time_format %Y-%m-%d %H:%M:%S,%L
  </parse>
</source>

# feed from local messages file
<source>
  @type tail
  read_lines_limit 10
  path /var/log/messages
  pos_file "/var/log/td-agent/messages.pos"
  tag messages
  <parse>
    @type syslog
  </parse>
</source>

# feed from containers syslog-ng - PAN only
<source>
  @type tail
  #read_lines_limit 10
  path /var/log/syslog-logs/p30*ccci*
  pos_file "/var/log/td-agent/pan.pos"
  tag pan.log
  <parse>
    @type none
  </parse>
</source>

# The following filter is to adjust timestamp for pan logs - adjust PAN est times to UTC
<filter pan.log>
   <record>
      # input time is a time in local timzone to pan - try to move to utc of syslog container
      newtime ${tz=TZInfo::Timezone.get("America/New_York");newtime=tz.local_to_utc(time, true);newtime.to_i.to_s}
   </record>
   type record_transformer
   renew_time_key newtime
   enable_ruby
</filter>

# feed from container's syslog-ng - except PAN logs
<source>
  @type tail
  read_lines_limit 10
  path /var/log/syslog-logs/*
  pos_file "/var/log/td-agent/syslog.pos"
  exclude_path ["/var/log/syslog-logs/p30*ccci*"]
  tag syslog-rfc5424
  <parse>
    @type multi_format

    <pattern>
      format regexp
      expression /^\<(?<pri>[0-9]{1,5})\>[1] (?<time>[0-9]{4}\-[0-9]{2}\-[0-9]{2}[T][0-9]{2}\:[0-9]{2}\:[0-9]{2}\.[0-9]{3}\+[0-9]{2}\:[0-9]{2}) (?<container>[^ ]*) (?<ident>[^ ]*) (?<pid>[-0-9]*) (?<msgid>[^ ]*) [\[](?<extradata>[^ ]*) \w*\=\"(?<project_name>[^\"]*)\" \w*\=\"(?<environment>[^\"]*)\"\] (?<orglg_date>[0-9]{4}\-[0-9]{2}\-[0-9]{2}) (?<orglg_time>[0-9]{2}\:[0-9]{2}\:[0-9]{2}\,[0-9]{3}) [\[](?<thread_name>[^ ]*)\] (?<orglg_msg_type>[^ ]*) (?<message>.+)$/
      time_format %Y-%m-%dT%H:%M:%S.%L%z
    </pattern>

    <pattern>
      format regexp
      expression /^\<(?<pri>[0-9]{1,5})\>[1] (?<time>[0-9]{4}\-[0-9]{2}\-[0-9]{2}[T][0-9]{2}\:[0-9]{2}\:[0-9]{2}\.[0-9]{3}\+[0-9]{2}\:[0-9]{2}) (?<container>[^ ]*) (?<ident>[^ ]*) (?<pid>[-0-9]*) (?<msgid>[^ ]*) [\[](?<extradata>[^ ]*) \w*\=\"(?<project_name>[^\"]*)\" \w*\=\"(?<environment>[^\"]*)\"\]\[[a-zA-Z,\s]+[\=\"]+(?<meta_seq_id>[\d]*)\"\] \[[a-zA-Z,\:]+(?<req_id>[^ ]*)\] (?<message>.+)$/
      time_format %Y-%m-%dT%H:%M:%S.%L%z
      types meta_seq_id:integer
    </pattern>

    <pattern>
      format regexp
      expression /^\<(?<pri>[0-9]{1,5})\>[1] (?<time>[0-9]{4}\-[0-9]{2}\-[0-9]{2}[T][0-9]{2}\:[0-9]{2}\:[0-9]{2}\.[0-9]{3}\+[0-9]{2}\:[0-9]{2}) (?<container>[^ ]*) (?<ident>[^ ]*) (?<pid>[-0-9]*) (?<msgid>[^ ]*) [\[](?<extradata>[^ ]*) \w*\=\"(?<project_name>[^\"]*)\" \w*\=\"(?<environment>[^\"]*)\"\]\[[a-zA-Z,\s]+[\=\"]+(?<meta_seq_id>[\d]*)\"\] (?<message>.+)$/
      time_format %Y-%m-%dT%H:%M:%S.%L%z
      types meta_seq_id:integer
    </pattern>

    <pattern>
      format regexp
      expression /^\<(?<pri>[0-9]{1,5})\>[1] (?<time>[0-9]{4}\-[0-9]{2}\-[0-9]{2}[T][0-9]{2}\:[0-9]{2}\:[0-9]{2}\.[0-9]{3}\+[0-9]{2}\:[0-9]{2}) (?<container>[^ ]*) (?<ident>[^ ]*) (?<pid>[-0-9]*) (?<msgid>[^ ]*) [\[](?<extradata>[^ ]*) \w*\=\"(?<project_name>[^\"]*)\" \w*\=\"(?<environment>[^\"]*)\"\] (?<message>.+)$/
      time_format %Y-%m-%dT%H:%M:%S.%L%z
    </pattern>

    <pattern>
      format regexp
      expression /^\<(?<pri>[0-9]{1,5})\>[1] (?<time>[0-9]{4}\-[0-9]{2}\-[0-9]{2}[T][0-9]{2}\:[0-9]{2}\:[0-9]{2}\.[0-9]{3}\+[0-9]{2}\:[0-9]{2}) (?<message>.+)$/
      time_format %Y-%m-%dT%H:%M:%S.%L%z
    </pattern>

    # catch all - if necessary
    <pattern>
      format regexp
      expression /^(?<message>.+)$/
    </pattern>
  </parse>
</source>

# feed from remote syslog-ng-stderr.log
<source>
  @type tail
  read_lines_limit 10
  path /var/log/syslog-ng-stderr.log
  pos_file "/var/log/td-agent/syslog-ng-stderr.pos"
  tag syslog-ng-stderr
  <parse>
    @type regexp
    expression /^\[(?<time>[0-9]{4}\-[0-9]{2}\-[0-9]{2}[T][0-9]{2}\:[0-9]{2}\:[0-9]{2}\.[0-9]{6})\] (?<message>.+)$/
    time_format %Y-%m-%dT%H:%M:%S.%L
  </parse>
</source>

# feed from remote syslog-ng-stdout remote files
# verified feed on 11/04/16
<source>
  @type tail
  read_lines_limit 10
  path /var/log/syslog-ng-stdout.log
  pos_file "/var/log/td-agent/syslog-ng-stdout.pos"
  tag syslog-ng-stdout
  <parse>
    @type regexp
    expression /^\[(?<time>[0-9]{4}\-[0-9]{2}\-[0-9]{2}[T][0-9]{2}\:[0-9]{2}\:[0-9]{2}\.[0-9]{6})\] (?<message>.+)$/
    time_format %Y-%m-%dT%H:%M:%S.%L
  </parse>
</source>

<system>
 root_dir /var/log/td-agent
</system>

#<match pan.log>
  ## send to datadog
  #@type datadog
  #@id awesome_agent
  #api_key DD_APPLICATION_KEY
  ##use_json true
  #include_tag_key true
  #tag_key 'tag'

  #dd_source 'pan'
  #dd_sourcecategory 'syslog'

  #<buffer>
    #@type file
    #path /var/log/td-agent/dd-buffer
    #chunk_limit_size 6MB
    #total_limit_size 5GB
    #chunk_full_threshold 0.95
    #queued_chunks_limit_size 8MB
    ##
    #flush_interval 10s
    #flush_mode interval
    #flush_thread_count 1
    #flush_thread_interval 2
    #flush_thread_burst_interval 3
    #delayed_commit_timeout 30
    #overflow_action throw_exception
    ##
    #retry_forever false
    #retry_max_times 10
    #retry_secondary_threshold 0.8
    #retry_type periodic
    #retry_wait 15s
    #retry_max_interval 5
  #</buffer>
#</match>

# Match all
<match **>
  # store to send to aws elasticsearch
  @type "aws-elasticsearch-service"
  logstash_format true
  include_tag_key true
  reload_on_failure false
  reload_connections false
  #resurrect_after 5
  <buffer>
    @type file
    path /var/log/td-agent/buffer
    chunk_limit_size 6MB
    #chunk_limit_records ##
    total_limit_size 5GB
    chunk_full_threshold 0.95
    queued_chunks_limit_size 8MB
    #
    flush_interval 10s
    flush_mode interval
    flush_thread_count 1
    flush_thread_interval 2
    flush_thread_burst_interval 3
    delayed_commit_timeout 30
    overflow_action throw_exception
    #
    retry_forever false
    #retry_timeout 15m
    retry_max_times 10
    retry_secondary_threshold 0.8
    retry_type periodic
    retry_wait 15s
    retry_max_interval 5
    #timekey_use_utc true
  </buffer>
  <endpoint>
    url
    region
    access_key_id
    secret_access_key
  </endpoint>
</match>

